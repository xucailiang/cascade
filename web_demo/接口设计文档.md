# Cascade VAD Web演示界面 - 接口设计文档

## 1. API概述

本文档详细描述了Cascade VAD Web演示界面的后端API接口设计，包括WebSocket实时通信接口和HTTP REST接口。这些接口支持麦克风实时流式输入和音频文件上传两种核心功能。

## 2. 基础信息

- **基础URL**: `http://localhost:8000`
- **WebSocket URL**: `ws://localhost:8000/ws`
- **API版本**: v1
- **数据格式**: JSON
- **认证方式**: 无（演示环境）

## 3. WebSocket接口

WebSocket接口用于实现实时音频流处理和结果推送，支持双向通信。

### 3.1 连接建立

```
WebSocket URL: ws://localhost:8000/ws
```

#### 查询参数

| 参数名 | 类型 | 必填 | 描述 |
|-------|-----|------|------|
| sample_rate | integer | 否 | 音频采样率，默认16000 |
| format | string | 否 | 音频格式，默认"float32" |
| channels | integer | 否 | 声道数，默认1 |

#### 连接示例

```javascript
const ws = new WebSocket('ws://localhost:8000/ws?sample_rate=16000&format=float32&channels=1');
```

### 3.2 客户端消息（Client → Server）

#### 3.2.1 开始录音

```json
{
  "type": "start_recording",
  "config": {
    "vad_threshold": 0.5,
    "chunk_duration_ms": 512,
    "overlap_ms": 32,
    "workers": 4,
    "backend": "silero"
  }
}
```

#### 3.2.2 音频数据块

```json
{
  "type": "audio_chunk",
  "data": [0.1, 0.2, -0.1, ...],  // Float32音频数据
  "timestamp": 1640995200000,     // 客户端时间戳(ms)
  "sequence": 123,                // 序列号
  "sample_rate": 16000            // 采样率
}
```

#### 3.2.3 配置更新

```json
{
  "type": "config_update",
  "config": {
    "vad_threshold": 0.7,         // 更新VAD阈值
    "chunk_duration_ms": 256,     // 更新块大小
    "overlap_ms": 16              // 更新重叠大小
  }
}
```

#### 3.2.4 停止录音

```json
{
  "type": "stop_recording"
}
```

#### 3.2.5 心跳检测

```json
{
  "type": "ping",
  "timestamp": 1640995200000
}
```

### 3.3 服务器消息（Server → Client）

#### 3.3.1 VAD检测结果

```json
{
  "type": "vad_result",
  "is_speech": true,              // 是否为语音
  "probability": 0.85,            // 置信度
  "start_ms": 1234.5,             // 开始时间(ms)
  "end_ms": 1756.8,               // 结束时间(ms)
  "chunk_id": 123,                // 对应的音频块ID
  "processing_time_ms": 2.3       // 处理耗时
}
```

#### 3.3.2 性能指标

```json
{
  "type": "performance_metrics",
  "metrics": {
    "avg_latency_ms": 2.5,        // 平均延迟
    "max_latency_ms": 5.1,        // 最大延迟
    "throughput_chunks_per_sec": 45.2,  // 吞吐量
    "active_threads": 4,          // 活跃线程数
    "buffer_utilization": 0.35,   // 缓冲区利用率
    "cpu_usage": 0.28,            // CPU使用率
    "memory_usage_mb": 85.4       // 内存使用
  },
  "timestamp": 1640995200000
}
```

#### 3.3.3 状态更新

```json
{
  "type": "status",
  "status": "processing",         // 状态: "idle", "processing", "error"
  "message": "正在处理音频流",
  "timestamp": 1640995200000
}
```

#### 3.3.4 错误信息

```json
{
  "type": "error",
  "code": "audio_format_error",
  "message": "不支持的音频格式",
  "details": {
    "format": "mp3",
    "supported_formats": ["wav", "pcm"]
  }
}
```

#### 3.3.5 心跳响应

```json
{
  "type": "pong",
  "timestamp": 1640995200000
}
```

### 3.4 WebSocket错误码

| 错误码 | 描述 |
|-------|------|
| 1000 | 正常关闭 |
| 1001 | 服务端关闭 |
| 1002 | 协议错误 |
| 1003 | 数据格式错误 |
| 1008 | 策略违规 |
| 1011 | 服务器内部错误 |

## 4. HTTP REST接口

HTTP REST接口主要用于文件上传、配置管理和静态资源访问。

### 4.1 文件上传接口

#### 请求

```
POST /api/upload
Content-Type: multipart/form-data
```

#### 参数

| 参数名 | 类型 | 必填 | 描述 |
|-------|-----|------|------|
| file | file | 是 | 音频文件 |
| vad_threshold | float | 否 | VAD阈值，默认0.5 |
| chunk_duration_ms | integer | 否 | 块大小，默认512 |
| overlap_ms | integer | 否 | 重叠大小，默认32 |
| workers | integer | 否 | 工作线程数，默认4 |
| backend | string | 否 | VAD后端，默认"silero" |

#### 响应

```json
{
  "status": "success",
  "file_id": "f8d7e9c2-1234-5678-abcd-ef1234567890",
  "filename": "recording.wav",
  "duration_sec": 10.5,
  "sample_rate": 16000,
  "channels": 1,
  "format": "wav",
  "results": [
    {
      "is_speech": true,
      "probability": 0.85,
      "start_ms": 1234.5,
      "end_ms": 1756.8
    },
    {
      "is_speech": true,
      "probability": 0.92,
      "start_ms": 3456.7,
      "end_ms": 4567.8
    }
  ],
  "performance": {
    "total_processing_time_ms": 245.6,
    "realtime_factor": 42.8,
    "avg_latency_ms": 2.5
  }
}
```

### 4.2 获取处理结果

#### 请求

```
GET /api/results/{file_id}
```

#### 参数

| 参数名 | 类型 | 必填 | 描述 |
|-------|-----|------|------|
| file_id | string | 是 | 文件ID |

#### 响应

```json
{
  "file_id": "f8d7e9c2-1234-5678-abcd-ef1234567890",
  "status": "completed",  // "processing", "completed", "error"
  "progress": 100,        // 处理进度百分比
  "results": [
    {
      "is_speech": true,
      "probability": 0.85,
      "start_ms": 1234.5,
      "end_ms": 1756.8
    },
    {
      "is_speech": true,
      "probability": 0.92,
      "start_ms": 3456.7,
      "end_ms": 4567.8
    }
  ],
  "performance": {
    "total_processing_time_ms": 245.6,
    "realtime_factor": 42.8,
    "avg_latency_ms": 2.5
  }
}
```

### 4.3 获取系统状态

#### 请求

```
GET /api/status
```

#### 响应

```json
{
  "status": "ready",      // "ready", "busy", "error"
  "version": "0.1.0",
  "uptime_sec": 3600,
  "active_connections": 2,
  "processed_files": 15,
  "processed_audio_sec": 450.5,
  "available_backends": ["silero", "onnx"],
  "system_info": {
    "cpu_usage": 0.28,
    "memory_usage_mb": 85.4,
    "active_threads": 4
  }
}
```

### 4.4 获取配置选项

#### 请求

```
GET /api/config/options
```

#### 响应

```json
{
  "vad_threshold": {
    "min": 0.1,
    "max": 0.9,
    "default": 0.5,
    "step": 0.05,
    "description": "语音检测阈值"
  },
  "chunk_duration_ms": {
    "options": [256, 512, 1024],
    "default": 512,
    "description": "音频块大小(毫秒)"
  },
  "overlap_ms": {
    "options": [16, 32, 64],
    "default": 32,
    "description": "重叠大小(毫秒)"
  },
  "workers": {
    "min": 1,
    "max": 8,
    "default": 4,
    "description": "工作线程数"
  },
  "backend": {
    "options": ["silero", "onnx"],
    "default": "silero",
    "description": "VAD后端"
  }
}
```

## 5. 数据模型

### 5.1 VADConfig

```python
class VADConfig(BaseModel):
    """VAD配置模型"""
    threshold: float = Field(0.5, ge=0.1, le=0.9, description="语音检测阈值")
    chunk_duration_ms: int = Field(512, description="音频块大小(毫秒)")
    overlap_ms: int = Field(32, description="重叠大小(毫秒)")
    workers: int = Field(4, ge=1, le=8, description="工作线程数")
    backend: str = Field("silero", description="VAD后端")
    
    class Config:
        json_schema_extra = {
            "example": {
                "threshold": 0.5,
                "chunk_duration_ms": 512,
                "overlap_ms": 32,
                "workers": 4,
                "backend": "silero"
            }
        }
```

### 5.2 AudioChunk

```python
class AudioChunk(BaseModel):
    """音频数据块模型"""
    data: List[float] = Field(..., description="音频数据")
    timestamp: int = Field(..., description="客户端时间戳(ms)")
    sequence: int = Field(..., description="序列号")
    sample_rate: int = Field(16000, description="采样率")
```

### 5.3 VADResult

```python
class VADResult(BaseModel):
    """VAD检测结果模型"""
    is_speech: bool = Field(..., description="是否为语音")
    probability: float = Field(..., description="置信度")
    start_ms: float = Field(..., description="开始时间(ms)")
    end_ms: Optional[float] = Field(None, description="结束时间(ms)")
    chunk_id: int = Field(..., description="对应的音频块ID")
    processing_time_ms: float = Field(..., description="处理耗时")
```

### 5.4 PerformanceMetrics

```python
class PerformanceMetrics(BaseModel):
    """性能指标模型"""
    avg_latency_ms: float = Field(..., description="平均延迟")
    max_latency_ms: float = Field(..., description="最大延迟")
    throughput_chunks_per_sec: float = Field(..., description="吞吐量")
    active_threads: int = Field(..., description="活跃线程数")
    buffer_utilization: float = Field(..., description="缓冲区利用率")
    cpu_usage: float = Field(..., description="CPU使用率")
    memory_usage_mb: float = Field(..., description="内存使用")
    timestamp: int = Field(..., description="时间戳")
```

## 6. 错误处理

### 6.1 错误码

| 错误码 | 描述 | HTTP状态码 |
|-------|------|-----------|
| audio_format_error | 不支持的音频格式 | 400 |
| file_too_large | 文件过大 | 413 |
| invalid_config | 无效的配置参数 | 400 |
| processing_error | 处理过程中出错 | 500 |
| not_found | 资源不存在 | 404 |
| server_busy | 服务器忙 | 503 |

### 6.2 错误响应格式

```json
{
  "error": {
    "code": "audio_format_error",
    "message": "不支持的音频格式",
    "details": {
      "format": "mp3",
      "supported_formats": ["wav", "pcm"]
    }
  }
}
```

## 7. 安全考虑

### 7.1 文件上传限制

- 最大文件大小: 50MB
- 支持的文件类型: wav, mp3, flac, ogg
- 文件扫描: 基本MIME类型验证

### 7.2 WebSocket连接限制

- 最大并发连接数: 10
- 连接超时: 60秒无活动自动断开
- 最大消息大小: 1MB

### 7.3 速率限制

- 文件上传: 10次/分钟
- API请求: 60次/分钟
- WebSocket消息: 100条/分钟

## 8. 实现注意事项

### 8.1 WebSocket实现

- 使用FastAPI的WebSocket支持
- 实现心跳机制保持连接
- 处理连接异常和重连逻辑

```python
@app.websocket("/ws")
async def websocket_endpoint(websocket: WebSocket):
    await websocket.accept()
    try:
        # 初始化VAD处理器
        processor = await initialize_vad_processor()
        
        # 处理WebSocket消息
        while True:
            data = await websocket.receive_json()
            # 处理不同类型的消息...
            
    except WebSocketDisconnect:
        # 处理断开连接
        pass
    finally:
        # 清理资源
        await processor.close()
```

### 8.2 文件上传处理

- 使用异步处理避免阻塞
- 实现进度跟踪
- 处理大文件的分块处理

```python
@app.post("/api/upload")
async def upload_file(
    file: UploadFile = File(...),
    vad_threshold: float = Form(0.5)
):
    # 验证文件
    validate_file(file)
    
    # 保存文件
    file_id = save_file(file)
    
    # 异步处理
    background_tasks.add_task(process_file, file_id, vad_threshold)
    
    return {"status": "processing", "file_id": file_id}
```

### 8.3 性能优化

- 使用线程池处理CPU密集型任务
- 实现缓存机制减少重复计算
- 使用异步IO处理网络和文件操作

## 9. 客户端集成示例

### 9.1 WebSocket连接示例

```javascript
// 建立WebSocket连接
const ws = new WebSocket('ws://localhost:8000/ws');

// 连接建立
ws.onopen = () => {
  console.log('WebSocket连接已建立');
  
  // 发送配置
  ws.send(JSON.stringify({
    type: 'start_recording',
    config: {
      vad_threshold: 0.5,
      chunk_duration_ms: 512
    }
  }));
};

// 接收消息
ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  
  switch (message.type) {
    case 'vad_result':
      // 处理VAD结果
      displayVADResult(message);
      break;
    case 'performance_metrics':
      // 更新性能指标
      updatePerformanceMetrics(message.metrics);
      break;
    case 'error':
      // 处理错误
      showError(message.message);
      break;
  }
};

// 发送音频数据
function sendAudioChunk(audioData) {
  if (ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({
      type: 'audio_chunk',
      data: Array.from(audioData),
      timestamp: Date.now(),
      sequence: sequenceNumber++
    }));
  }
}
```

### 9.2 文件上传示例

```javascript
// 文件上传
async function uploadFile(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('vad_threshold', 0.5);
  formData.append('workers', 4);
  
  try {
    const response = await fetch('/api/upload', {
      method: 'POST',
      body: formData
    });
    
    const result = await response.json();
    
    if (result.status === 'success') {
      // 处理成功结果
      displayResults(result.results);
    } else {
      // 处理错误
      showError(result.error.message);
    }
  } catch (error) {
    console.error('上传失败:', error);
  }
}
```

## 10. 测试计划

### 10.1 API测试用例

| 测试ID | 接口 | 测试场景 | 预期结果 |
|-------|------|---------|---------|
| WT-01 | WebSocket | 建立连接 | 连接成功 |
| WT-02 | WebSocket | 发送音频数据 | 接收VAD结果 |
| WT-03 | WebSocket | 更新配置 | 配置更新成功 |
| WT-04 | WebSocket | 断开重连 | 重连成功 |
| FT-01 | 文件上传 | 上传WAV文件 | 处理成功 |
| FT-02 | 文件上传 | 上传不支持格式 | 返回错误 |
| FT-03 | 文件上传 | 上传超大文件 | 返回错误 |
| ST-01 | 系统状态 | 获取状态 | 返回正确状态 |

### 10.2 性能测试

- 并发WebSocket连接: 10个同时连接
- 文件处理性能: 10分钟音频文件处理时间
- 实时处理延迟: 测量端到端延迟
- 资源使用: CPU和内存使用监控