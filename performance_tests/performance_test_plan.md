# Cascade 流式音频处理性能测试方案

## 1. 测试概述

### 1.1 测试目标

本测试方案旨在评估Cascade流式音频处理库的性能特性，重点关注：

1.  **流式音频处理接口性能**：测试主要API入口方法的处理延迟、吞吐量和资源使用情况
2.  **高并发调用性能**：测试在多个并发音频流同时处理时的系统表现

### 1.2 测试范围

本测试方案重点测试以下API入口方法：

-   `process_audio_file`
-   `StreamProcessor.process_stream`
-   `StreamProcessor.process_chunk`

## 2. 测试指标与评估标准

### 2.1 性能指标

-   **延迟指标**: 平均处理延迟、最大处理延迟、延迟分布
-   **吞吐量指标**: 每秒处理帧数、实时因子
-   **资源使用指标**: 内存使用、CPU使用率
-   **稳定性指标**: 长时间运行稳定性、错误率

### 2.2 评估标准

| 性能等级 | 平均延迟 | 吞吐量(fps) | 实时因子 |
| --- | --- | --- | --- |
| 优秀 | < 50ms | > 100 | > 5x |
| 良好 | < 100ms | > 50 | > 2x |
| 一般 | < 200ms | > 20 | > 1x |

## 3. 测试场景

### 3.1 流式音频处理接口测试

-   **场景1：不同音频块大小测试**
    -   **目标**: 测试不同音频块大小对性能的影响。
    -   **方法**: 使用`StreamProcessor.process_chunk`，改变块大小（512B to 16KB）。
-   **场景2：流式处理性能测试**
    -   **目标**: 测试处理不同时长音频流的性能。
    -   **方法**: 使用`StreamProcessor.process_stream`，处理不同时长（5s to 60s）的模拟音频流。
-   **场景3：文件处理性能测试**
    -   **目标**: 测试处理完整音频文件的性能。
    -   **方法**: 使用`process_audio_file`，处理不同时长的WAV文件。

### 3.2 高并发调用测试

-   **场景1：固定并发数测试**
    -   **目标**: 测试固定并发数下的系统性能。
    -   **方法**: 并发调用`StreamProcessor.process_chunk`，并发数从1递增到32。
-   **场景2：动态增加并发数测试**
    -   **目标**: 测试系统对动态变化的负载的适应性。
    -   **方法**: 模拟用户陆续加入，逐步增加并发任务至30个。
-   **场景3：混合并发测试**
    -   **目标**: 测试不同API入口混合调用时的性能。
    -   **方法**: 同时并发调用`process_audio_file`, `process_stream`, `process_chunk`。

## 4. 测试实现框架

将创建一个名为 `performance_tests/run_benchmark.py` 的脚本来自动化执行以上所有测试场景。该脚本将：
1.  使用 `numpy` 生成测试音频数据。
2.  使用 `psutil` 监控CPU和内存使用。
3.  使用 `asyncio.gather` 执行并发测试。
4.  使用 `matplotlib` 将测试结果可视化，并保存为图片。
5.  打印格式化的测试报告到控制台。